#!/usr/bin/env bash
	OUT=$(mktemp)
	
    echo "Usage: ./pdfgrepSIXEL 'String'"
	IFS=" " #delimiter
	#results in syntax: pdfname.pdf:pagenumber:searchstring
	resultslist=$(pdfgrep -n -H -o $1 *.pdf)
	resultscount=$(echo $resultslist | cut -d ':' -f 1 | uniq -c | awk '{print $1}') #results per pdf
	deduplicatedlist=$(echo $resultslist  | awk '!a[$0]++') #deduplicate
	pageslist=$(echo $deduplicatedlist | cut -d ':' -f 2) #page numbers
	resultpages=$(echo $deduplicatedlist | cut -d ':' -f 1 | uniq -c | awk '{print $1}') #resultpages per pdf
	
	#determine individual pdf files:
    uniquepdfnames=$(echo $deduplicatedlist | cut -d ':' -f 1 | sort -u)
    unset IFS
    uniquepdfcount=$(echo $uniquepdfnames | wc -w)
    echo "Found $(echo $resultslist | wc -w) results inside $uniquepdfcount pdf files"
    echo "(Results per pdf: "$resultscount")"

    i=1 #number of file
    field=1 #position in pagelist
    while [ $i -le $uniquepdfcount ]; do #less or equals https://www.ibm.com/support/knowledgecenter/en/ssw_aix_72/osmanagement/korn_shell_conditional_exp.html
        
            #different pdf files:
            resultsthispdf=$(echo $resultpages | awk -v N=$i '{print $N}') #better than loop with ${resultpages:2:1} \o/
            
            currentpages=$(echo $pageslist | cut -d " " -f $field-$(($field+$resultsthispdf-1)))
            field=$(($field+$resultsthispdf))
            
            #echo $uniquepdfnames | cut -d " " -f$i
            #echo ~$currentpages~
            #echo [$resultsthispdf]
            #echo $pageslist
            #echo ------
            
            pdfsites=$pdfsites$currentpages$([ $i -ne $uniquepdfcount ] && echo "; ")
            qpdflist=$qpdflist$(echo $uniquepdfnames | cut -d " " -f$i)" "$(echo $currentpages | tr " " ",")" "
            #echo $qpdflist
            #different pdf files end
            
            SEP=$(mktemp)
            convert -background red -fill white -pointsize 16 label:"$(echo $uniquepdfnames | cut -d " " -f$i)" pdf:$SEP
            pdfseparator=$pdfseparator$SEP" "$OUT" "$(($field-$resultsthispdf))-$(($field-1))" "
            #echo $pdfseparator
        i=$((i + 1))
    done
        
    echo $uniquepdfnames
    pagecount=$(echo $pageslist | wc -w)
    echo "Pages: " $pagecount "(" $pdfsites ")"
    echo "[Pages per pdf: " $resultpages"]"

	qpdf --empty --pages $qpdflist -- - \
	| gs -dBATCH -dNOPAUSE -q -sDEVICE=pdfwrite -g2048x2048 -dPDFFitPage -sOutputFile=- - \
	| convert -alpha remove - pdf:$OUT
	qpdf --empty --pages $pdfseparator -- - | convert - sixel:-
